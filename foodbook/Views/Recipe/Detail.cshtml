@model dynamic
@{
    ViewData["Title"] = Model.Recipe.name;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/recipe-detail.css" asp-append-version="true" />

@Html.AntiForgeryToken()

<!-- Back Button -->
<div class="mb-3">
    <a href="javascript:history.back()" class="text-decoration-none text-muted" style="font-size: 14px;">
        <i class="bi bi-arrow-left"></i> Quay lại
    </a>
</div>

<!-- Recipe Title with Level Badge -->
<div class="d-flex align-items-center gap-2 mb-2">
    <h1 class="recipe-title mb-0">@Model.Recipe.name</h1>
    <span class="badge bg-success level-badge">@Model.Recipe.level</span>
</div>

<!-- Author Info with Follow Button -->
<div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex align-items-center gap-2">
        @if (!string.IsNullOrEmpty(Model.Author?.avatar_img))
        {
            <img src="@Model.Author.avatar_img" alt="@Model.Author?.full_name ?? Model.Author?.username" 
                 class="rounded-circle recipe-author-avatar" style="width: 56px; height: 56px; object-fit: cover;">
        }
        else
        {
            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center recipe-author-avatar" 
                 style="width: 56px; height: 56px; font-size: 24px;">
                <i class="bi bi-person"></i>
            </div>
        }
        <a href="@Url.Action("Info", "Profile", new { id = Model.Author?.user_id })" 
           class="text-decoration-none text-dark recipe-author-name">
            @(Model.Author?.full_name ?? Model.Author?.username ?? "Người dùng")
        </a>
        @if (!Model.IsOwnRecipe)
        {
            <button class="btn @(Model.IsFollowing ? "btn-outline-secondary" : "btn-outline-success") btn-sm follow-btn" 
                    data-user-id="@Model.Author.user_id" 
                    data-is-following="@Model.IsFollowing.ToString().ToLower()">
                @(Model.IsFollowing ? "Đã theo dõi" : "Theo dõi")
            </button>
        }
    </div>
    
    <!-- Action Buttons -->
    <div class="d-flex gap-2">
        @if (Model.IsOwnRecipe)
        {
            <a href="@Url.Action("Edit", "Recipe", new { id = Model.Recipe.recipe_id })" class="btn btn-primary btn-sm">
                <i class="bi bi-pencil-square"></i> Chỉnh sửa
            </a>
        }
        <button class="btn @(Model.IsSaved ? "btn-warning" : "btn-success") btn-sm save-btn" id="btnSaveRecipe" 
                data-recipe-id="@Model.Recipe.recipe_id" data-is-saved="@Model.IsSaved">
            <i class="bi @(Model.IsSaved ? "bi-bookmark-fill" : "bi-bookmark")"></i>
            <span class="save-text">@(Model.IsSaved ? "Đã lưu" : "Lưu công thức")</span>
        </button>
        
        @if (!Model.IsOwnRecipe)
        {
            <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#reportRecipeModal">
                <i class="bi bi-flag"></i>
                Báo cáo
            </button>
        }
    </div>
</div>

<!-- Recipe Stats -->
<div class="d-flex align-items-center gap-3 text-muted mb-3 recipe-stats">
    <span class="stat-item cursor-pointer" id="btnLike" data-recipe-id="@Model.Recipe.recipe_id" data-is-liked="@Model.IsLiked.ToString().ToLower()">
        <i class="bi @(Model.IsLiked ? "bi-hand-thumbs-up-fill text-primary" : "bi-hand-thumbs-up")"></i>
        <span id="likeCount">@Model.LikeCount</span>
    </span>
    <span class="stat-item">
        <i class="bi bi-chat"></i>
        <span>@Model.CommentCount</span>
    </span>
    <span class="stat-item cursor-pointer" id="btnShare" data-recipe-id="@Model.Recipe.recipe_id">
        <i class="bi bi-share"></i>
        <span id="shareCount">@Model.ShareCount</span>
    </span>
    <span class="stat-item cook-time-stat">
        <i class="bi bi-clock"></i>
        <strong>@Model.Recipe.cook_time phút</strong>
    </span>
</div>

<!-- Thumbnail with Step Media Gallery -->
@if (!string.IsNullOrEmpty(Model.Recipe.thumbnail_img))
{
    <div class="mb-4">
        <div class="row g-3 align-items-start">
            <div class="col-12 col-md-10">
                <div class="recipe-thumbnail rounded-3" id="mainMediaDisplay" style="transition: opacity .25s ease; opacity: 1; position: relative; width: 100%; aspect-ratio: 16/9; overflow: hidden; background: url('@Model.Recipe.thumbnail_img') center / cover no-repeat;">
                </div>
            </div>
            <div class="col-12 col-md-2">
                <div class="d-flex flex-row flex-md-column gap-2 justify-content-start gallery-thumbnails-container">
                    <a href="javascript:void(0)" class="gallery-thumb" data-media-type="image" data-media-url="@Model.Recipe.thumbnail_img" aria-label="Thumbnail" style="display:block; width:100%; aspect-ratio: 1/1; overflow:hidden;">
                        <img src="@Model.Recipe.thumbnail_img" alt="Thumb" class="img-fluid rounded border" style="width:100%; height:100%; object-fit: cover;">
                    </a>
                    @{ var thumbCount = 0; var maxThumbs = 6; }
                    @foreach (var step in Model.Steps)
                    {
                        if (thumbCount >= maxThumbs) { break; }
                        if (Model.StepMedia.ContainsKey(step.step) && Model.StepMedia[step.step].Count > 0)
                        {
                            foreach (var media in Model.StepMedia[step.step])
                            {
                                if (thumbCount >= maxThumbs) { break; }
                                if (!string.IsNullOrEmpty(media.media_img))
                                {
                                    <a href="javascript:void(0)" class="gallery-thumb" data-media-type="image" data-media-url="@media.media_img" aria-label="Ảnh bước @step.step" style="display:block; width:100%; aspect-ratio: 1/1; overflow:hidden;">
                                        <img src="@media.media_img" alt="Ảnh bước @step.step" class="img-fluid rounded border" style="width:100%; height:100%; object-fit: cover;">
                                    </a>
                                    thumbCount++;
                                }
                                else if (!string.IsNullOrEmpty(media.media_video))
                                {
                                    <a href="javascript:void(0)" class="gallery-thumb" data-media-type="video" data-media-url="@media.media_video" aria-label="Video bước @step.step">
                                        <video class="img-fluid rounded border" preload="metadata" muted>
                                            <source src="@media.media_video" type="video/mp4">
                                        </video>
                                    </a>
                                    thumbCount++;
                                }
                            }
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- Description Section -->
<div class="recipe-section mb-4">
    <h5 class="section-title mb-3">Mô tả nguyên liệu</h5>
    <div class="ingredients-box">
        <p class="mb-0" style="white-space: pre-line;">@Model.Recipe.description</p>
    </div>
</div>

<!-- Recipe Steps Section -->
@{
    int stepIndex = 0;
}
@foreach (var step in Model.Steps)
{
    <div class="recipe-step mb-3">
        <div class="step-header collapsed" data-bs-toggle="collapse" data-bs-target="#step@(step.step)">
            <span class="step-title">Bước @step.step</span>
            <i class="bi bi-chevron-down step-chevron"></i>
        </div>
        
        <div id="step@(step.step)" class="collapse">
            <div class="step-content">
                <!-- Step Description -->
                <div class="step-description mb-3">
                    <div class="step-label">Mô tả bước:</div>
                    <p class="step-text">@step.instruction</p>
                </div>
                
                <!-- Step Media -->
                @if (Model.StepMedia.ContainsKey(step.step) && Model.StepMedia[step.step].Count > 0)
                {
                    var mediaList = Model.StepMedia[step.step];
                    
                    <div class="step-media-wrapper" id="mediaContainer@(step.step)">
                        @for (int i = 0; i < mediaList.Count; i++)
                        {
                            var media = mediaList[i];
                            var displayStyle = i == 0 ? "display: inline-flex;" : "display: none;";
                            
                            <div class="step-media-item position-relative" data-step="@step.step" data-index="@i" style="@displayStyle">
                                @if (!string.IsNullOrEmpty(media.media_img))
                                {
                                    <img src="@media.media_img" alt="Step @step.step" 
                                         class="step-image" 
                                         onclick="showImageModal('@media.media_img')">
                                    
                                    @if (mediaList.Count > 1)
                                    {
                                        <div class="step-number-badge">@(i + 1)</div>
                                    }
                                }
                                else if (!string.IsNullOrEmpty(media.media_video))
                                {
                                    <video controls class="step-image" preload="metadata">
                                        <source src="@media.media_video" type="video/mp4">
                                        Trình duyệt của bạn không hỗ trợ video.
                                    </video>
                                }
                            </div>
                        }
                        
                        @if (mediaList.Count > 1)
                        {
                            <!-- Navigation Arrows -->
                            <button class="media-nav-btn prev-btn" onclick="navigateStepMedia(@step.step, -1)">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <button class="media-nav-btn next-btn" onclick="navigateStepMedia(@step.step, 1)">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
    stepIndex++;
}

<!-- Comments Section -->
<div class="comments-section">
    <h5 class="section-title mb-3">Bình luận của bạn</h5>
    
    <!-- Comment Form -->
    <form id="commentForm" class="comment-form mb-4" data-recipe-id="@Model.Recipe.recipe_id">
        <textarea class="comment-input" id="commentBody" rows="3" 
                  placeholder="Viết bình luận của bạn..." required></textarea>
        <div class="text-end mt-2">
            <button class="btn btn-success comment-submit-btn" type="submit">
                Gửi bình luận
            </button>
        </div>
    </form>
    
    <!-- Comments List -->
    <div id="commentsList">
        @if (Model.Comments.Count > 0)
        {
            foreach (var commentItem in Model.Comments)
            {
                <div class="comment-item">
                    <div class="d-flex gap-2">
                        <div class="comment-avatar">
                            @if (!string.IsNullOrEmpty(commentItem.User?.avatar_img))
                            {
                                <img src="@commentItem.User.avatar_img" alt="@(commentItem.User?.full_name ?? commentItem.User?.username)" 
                                     class="rounded-circle comment-user-avatar" style="width: 48px; height: 48px; object-fit: cover;">
                            }
                            else
                            {
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center comment-user-avatar" 
                                     style="width: 48px; height: 48px; font-size: 20px;">
                                    <i class="bi bi-person"></i>
                                </div>
                            }
                        </div>
                        <div class="comment-body">
                            <div class="comment-author">@(commentItem.User?.full_name ?? commentItem.User?.username ?? "Người dùng")</div>
                            <div class="comment-text">@commentItem.Comment.body</div>
                            <div class="comment-time">
                                @{
                                    var timeAgo = DateTime.UtcNow - commentItem.Comment.created_at;
                                    if (timeAgo.TotalMinutes < 1)
                                    {
                                        <text>Vừa xong</text>
                                    }
                                    else if (timeAgo.TotalMinutes < 60)
                                    {
                                        <text>@((int)timeAgo.TotalMinutes) phút trước</text>
                                    }
                                    else if (timeAgo.TotalHours < 24)
                                    {
                                        <text>@((int)timeAgo.TotalHours) giờ trước</text>
                                    }
                                    else
                                    {
                                        <text>@commentItem.Comment.created_at.ToString("dd/MM/yyyy")</text>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-muted text-center py-4" style="font-size: 14px;">Chưa có bình luận nào. Hãy là người đầu tiên!</p>
        }
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0 position-relative">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" 
                        data-bs-dismiss="modal" style="z-index: 1051;"></button>
                <img id="modalImage" src="" alt="Recipe Image" style="max-width: 100%; max-height: 90vh; width: auto; height: auto; object-fit: contain;">
            </div>
        </div>
    </div>
</div>

<!-- Report Recipe Modal -->
<div class="modal fade" id="reportRecipeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Báo cáo công thức</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Vui lòng cho chúng tôi biết lý do báo cáo công thức này:</p>
                <div class="mb-3">
                    <label for="reportReason" class="form-label">Lý do <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="reportReason" rows="4" 
                              placeholder="Ví dụ: Nội dung không phù hợp, spam, vi phạm bản quyền..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="btnReportRecipe" data-recipe-id="@Model.Recipe.recipe_id">Gửi báo cáo</button>
            </div>
        </div>
    </div>
</div>

<!-- Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <i id="alertIcon" class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h5 id="alertTitle" class="mb-3">Thành công</h5>
                <p id="alertMessage" class="mb-0"></p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/recipe-detail.js" asp-append-version="true"></script>
}
