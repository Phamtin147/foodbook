-- Bước 1: Xóa constraint UNIQUE trên media_id của RecipeStep
ALTER TABLE public.RecipeStep 
DROP CONSTRAINT IF EXISTS RecipeStep_media_id_key;

-- Bước 2: Xóa cột media_id khỏi RecipeStep (nếu muốn)
ALTER TABLE public.RecipeStep 
DROP COLUMN IF EXISTS media_id;

-- Bước 3: Tạo bảng trung gian
CREATE TABLE public.RecipeStep_Media (
  recipe_id integer NOT NULL,
  step integer NOT NULL,
  media_id integer NOT NULL,
  display_order integer DEFAULT 1,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT RecipeStep_Media_pkey PRIMARY KEY (recipe_id, step, media_id),
  CONSTRAINT fk_stepmedia_recipestep FOREIGN KEY (recipe_id, step) 
    REFERENCES public.RecipeStep(recipe_id, step) ON DELETE CASCADE,
  CONSTRAINT fk_stepmedia_media FOREIGN KEY (media_id) 
    REFERENCES public.Media(media_id) ON DELETE CASCADE
);

-- Bước 4: Tạo index để query nhanh
CREATE INDEX idx_stepmedia_recipe_step 
ON public.RecipeStep_Media(recipe_id, step);

CREATE INDEX idx_stepmedia_order 
ON public.RecipeStep_Media(recipe_id, step, display_order);

-- Query để lấy tất cả media của 1 step (có thứ tự):
-- SELECT m.* 
-- FROM RecipeStep_Media rsm
-- JOIN Media m ON rsm.media_id = m.media_id
-- WHERE rsm.recipe_id = ? AND rsm.step = ?
-- ORDER BY rsm.display_order;

-- Query để thêm media vào step:
-- INSERT INTO RecipeStep_Media (recipe_id, step, media_id, display_order)
-- VALUES (?, ?, ?, ?);

-- Query để xóa 1 media khỏi step:
-- DELETE FROM RecipeStep_Media 
-- WHERE recipe_id = ? AND step = ? AND media_id = ?;